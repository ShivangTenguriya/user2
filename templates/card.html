<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scratch Card with Confetti</title>
<style>
  body {
    font-family: Arial, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background: #f0f0f0;
  }
  .scratch-card {
    position: relative;
    width: 320px;
    height: 160px;
    border: 2px solid #333;
    border-radius: 15px;
    overflow: hidden;
    text-align: center;
    line-height: 160px;
    font-size: 20px;
    font-weight: bold;
    background-color: #ccc;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  canvas {
    position: absolute;
    top: 0;
    left: 0;
  }
  #confetti-canvas {
    position: fixed;
    pointer-events: none;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
  }
</style>
</head>
<body>

<div class="scratch-card" id="scratchCard">
  YOUR COUPON: <span id="code">WAITING...</span>
  <canvas id="scratchCanvas" width="320" height="160"></canvas>
</div>
<canvas id="confetti-canvas"></canvas>

<script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
const USER_ID = 1; // Logged-in user ID
const canvas = document.getElementById('scratchCanvas');
const ctx = canvas.getContext('2d');
const codeEl = document.getElementById('code');
const confettiCanvas = document.getElementById('confetti-canvas');

let couponData = null;
let isDrawing = false;
const radius = 20; 
const revealThreshold = 0.4; 


const gradient = ctx.createLinearGradient(0,0,canvas.width,canvas.height);
gradient.addColorStop(0, '#bbb');
gradient.addColorStop(1, '#888');
ctx.fillStyle = gradient;
ctx.fillRect(0, 0, canvas.width, canvas.height);

const socket = io("https://customer-0prn.onrender.com/payment_confirm_user");
socket.emit('join_room', {user_id: USER_ID});

socket.on('payment_success_coupon', (data) => {
    couponData = data;
    codeEl.innerText = `SCRATCH TO REVEAL!`;
});


canvas.addEventListener('mousedown', () => isDrawing = true);
canvas.addEventListener('mouseup', () => isDrawing = false);
canvas.addEventListener('mouseleave', () => isDrawing = false);
canvas.addEventListener('mousemove', scratch);
canvas.addEventListener('touchstart', () => isDrawing = true);
canvas.addEventListener('touchend', () => isDrawing = false);
canvas.addEventListener('touchmove', (e) => {
  const touch = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  scratch({ clientX: touch.clientX, clientY: touch.clientY, preventDefault: () => e.preventDefault() });
});

function scratch(e) {
    if (!isDrawing || !couponData) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    
    const brush = ctx.createRadialGradient(x, y, 0, x, y, radius);
    brush.addColorStop(0, 'rgba(0,0,0,1)');
    brush.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.globalCompositeOperation = 'destination-out';
    ctx.fillStyle = brush;
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, Math.PI * 2);
    ctx.fill();

    checkReveal();
}

function checkReveal() {
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    let transparentPixels = 0;
    for (let i = 3; i < imageData.data.length; i += 4) {
        if (imageData.data[i] === 0) transparentPixels++;
    }

    const totalPixels = canvas.width * canvas.height;
    if (transparentPixels / totalPixels > revealThreshold) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        codeEl.innerText = `${couponData.coupon_code} - ${couponData.discount}% OFF (Expires: ${couponData.expiry_date})`;
        canvas.removeEventListener('mousemove', scratch);
        canvas.removeEventListener('touchmove', scratch);

        
        launchConfetti();
    }
}


function launchConfetti() {
    const myConfetti = confetti.create(confettiCanvas, {
        resize: true,
        useWorker: true
    });
    myConfetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.6 }
    });
}
</script>

</body>
</html>
